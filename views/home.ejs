<!DOCTYPE html>
<html lang="en">
<head>
    <%-include ('./partials/header.ejs', {title: 'Home'}) %>
    <link rel="stylesheet" href="/styles/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100&display=swap" rel="stylesheet">
</head>
<%- include ('./partials/nav.ejs') %>
<body>

<% // Get the current date %>
<% function getText(code) {
  switch (code) {
      case 'DLR':
          return 'Disneyland Resort'
      case 'WDW':
          return 'Walt Disney World Resort'
      case 'DP':
          return 'Disneyland Park'
      case 'CA':
          return 'California Adventure'
      case 'MK':
          return 'Magic Kingdom'
      case 'EPCOT':
          return 'Epcot'
      case 'HS':
          return 'Hollywood Studios'
      case 'AK':
          return 'Animal Kingdom'
  }
  
}; %>
<<% if (!user) {%>
<% let userPass = 'inspire-key-pass' %>
<% } else
{ %>
<% let userPass = user.defaultPass %>
<% } %>
<% let passAvailability = availability.find((a) => a.passType === userPass) %>>
<div class="legend">
<p class="legend"><strong>Legend: </strong></p>
<p>
  <% if (resort === 'DLR')
  { %>
    <img class = "icons" src="/assets/DLR_DP.png"> - Disneyland Park
    <img class = "icons"src="/assets/DLR_CA.png"> - California Adventure
    <img class = "icons" src ="/assets/both.png"> - Both Parks Available
  <% } else if (resort === 'WDW')
  { %>
    <img class = "icons"src="/assets/WDW_MK.png"> - Magic Kingdom
    <img class = "icons"src="/assets/WDW_EP.png"> - Epcot
    <img class = "icons"src="/assets/WDW_HS.png"> - Hollywood Studios
    <img class = "icons" src="/assets/WDW_AK.png"> - Animal Kingdom
  <% } %>
<img class = "icons" src="/assets/green.png"> - Currently Unavailable

</p>
</div>
<% let today = new Date(); %>
<% let weekCounter = 0; %>


<% // Array of month names %>
<% let monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]; %>

<% // Array of day names %>
<% let dayNames = ["S", "M", "T", "W", "T", "F", "S"]; %>

<% // Function to generate calendar HTML %> 
<% function generateCalendarHTML(date) { %>
  <% // Create a new date object for the given month %>
  <% let month = new Date(date.getFullYear(), date.getMonth(), 1); %>
<% weekCounter = 0; %>
  <% // Start building the HTML %>
  <% let html = '<div class="calendar">'; %> 
  <% html += '<div class="month">' + monthNames[month.getMonth()] + ' ' + month.getFullYear() + '</div>'; %>

  <% // Add the day labels %>
  <% html += '<div class="week">'; %> 
 <% for (let i = 0; i < 7; i++) { %>
    <% html += '<div class="day">' + dayNames[i] + '</div>'; %>
  <% } %>
  <% html += '</div>'; %>

  <% // Add the days of the month %>
  <% let week = '<div class="week">'; %> 
    <% weekCounter += 1; %>
  <% for (let i = 0; i < month.getDay(); i++) { %>
    <% week += '<div class="day empty"></div>'; %>
  <% }  %>
  <% while (month.getMonth() === date.getMonth()) { %> 
    <% let resortMonth = (month.getMonth() + 1).toString().padStart(2, '0'); %>
    <% let resortDate = month.getDate().toString().padStart(2, '0'); %>
    <% let resortYear = month.getFullYear(); %>
    <% let resortFullDate = resortYear + '-' + resortMonth + '-' + resortDate; %>
    <% let resortAvailability = passAvailability['calendar-availabilities'].find(avail => avail.date === resortFullDate); %>
    <% let resortClass = ''; %>
    <% let imgHTML = ''; %>
    <% let modalHTML = ''; %>
    <% if (resortAvailability !== undefined) { %>
      <% modalHTML = `<div class="modal" id="modal-${resortFullDate}">` %>
      <% modalHTML += `<div class="modal-content">` %>
      <% modalHTML += `<div class="modal-header">` %>
      <% modalHTML += `<span class="close" id="close-${resortFullDate}">&times;</span>` %>
      <% modalHTML += `<h3>Availability for ${resortFullDate}</h3>` %>
      <% modalHTML += `</div>` %>
      <% modalHTML += `<div class="modal-body">` %>
      <% modalHTML += `<div class="modal-body-content">` %>
      <% modalHTML += `<div class="modal-body-content-left">` %>
        <% let textResort = getText(resort); %> 
      <% modalHTML += `<p>Resort: ${textResort}</p>` %>
      <% modalHTML += `<p>Park Availability: </p>` %>
      <% modalHTML += `</div>` %>
      <% modalHTML += `<div class="modal-body-content-right">` %>
      <% for (facilities of resortAvailability.facilities) { %>
        <% modalHTML += `<div class="facilities">` %>
        <% modalHTML += `<img src=/assets/${facilities.facilityName}.png>` %>
        <% modalHTML += `<p>${facilities.available ? 'Available' : facilities.blocked ? 'Blocked Out' : 'No Reservations'}</p>` %>
        <% if (facilities.available && resort === 'DLR'){
          modalHTML += `<a href="https://disneyland.disney.go.com/entry-reservation/" target="_blank"><button>Book Now</button></a>`
        }else if (facilities.available && resort === 'WDW'){
          modalHTML += `<a href="https://disneyworld.disney.go.com/entry-reservation/" target="_blank"><button>Book Now</button></a>`
        }else if (!facilities.available){
          modalHTML += `<a href="/requests/new/640d649def9a82312f066ba0/${resortFullDate}/${facilities.facilityName}"><button>Request a Notification</button></a>`
        } %>

          
        <% modalHTML += `</div>` %>
      <% } %>
      <% modalHTML += `<div class ="facilities">` %>
        <% modalHTML += `<img src='/assets/WDW_ALL.webp'><p>Any Park</p><a href="/requests/new/640d649def9a82312f066ba0/${resortFullDate}/${resort}_ANY"><button>Request Any Park</button></a>` %>
        <% modalHTML += `</div>` %>
      <% modalHTML += `</div>` %>
      <% modalHTML += `</div>` %>
      <% modalHTML += `</div>` %>
      <% modalHTML += `</div>` %>
      <% modalHTML += `</div>` %>
      <% html += modalHTML; %>
      

      <% if (resortAvailability.availability === 'cms-key-all-availability' ) { %>
        <% if (resort === 'DLR') { %>
          <% resortClass = 'both' %>
          <% imgHTML = `<img src="/assets/both.png" alt="both" style="width: 27px; height: 15px;">` %>
        <% }else{
          resortClass = 'all'
          imgHTML = `<img src="/assets/all.png" alt="all" style="width: 27px; height: 15px;">`
        } %>
        
        <% }else if (resortAvailability.availability === 'cms-key-at-least-one-availability') { %>
          <% if (resort === 'DLR') { %>
            <% resortClass = resortAvailability.facilities.find(resort => resort.available === true).facilityName; %>
            <% imgHTML = `<img src="/assets/${resortClass}.png" alt="${resortClass}" style="width: 15px; height: 15px;"></a>` %> 
          <% }else{
            resortClass = 'some'
            imgHTML = `<img src="/assets/some.png" alt="some" style="width: 27px; height: 15px;">`
          } %>
          
        <% }else if (resortAvailability.availability === 'cms-key-no-availability') { %>
            <% imgHTML = `<img src="/assets/green.png" alt="yellow" style="width: 15px; height: 15px;">` %>
        <% } %>
    <% }else{ %>
        <% resortClass = 'slash' %>
    <% } %>
    

    
    <% week += `<div class='day ${resortClass}' id='${resortFullDate}'>` + month.getDate() + '</a>' + imgHTML + '</div>'; %>
    

    
    <% if (month.getDay() === 6) { %> 
      <% week += '</div><div class="week">'; %> 
        <% weekCounter += 1; %>
    <% } %>
    <% month.setDate(month.getDate() + 1); %>
  <% } %>
  <% for (let i = month.getDay(); i < 7; i++) { %> 
    <% week += '<div class="day empty"></div>'; %>
  <% } %>
  <% html += week + '</div>'; %>

  <% // Close the calendar div %> 
  <% if (weekCounter === 5){ %>
    <% html += '<div class="week">'; %>
    <% for (let i = 0; i < 7; i++) { %>
        <% html += '<div class="day empty"></div>'; %>
    <% } %>
    <% html += '</div>'; %>
    <% } %>
  <% html += '</div>'; %> 

  <% return html; %> 
<% } %>

<% // Generate HTML for the next four months %>
<% let calendarHTML = ''; %>
<% for (let i = 0; i < 4; i++) { %> 
  <% calendarHTML += generateCalendarHTML(new Date(today.getFullYear(), today.getMonth() + i, 1)); %> 
<% } %>
<div id="calendars">
<%- calendarHTML %>
</div>
<script src="/js/calendar.js" defer></script>
</body>
</html>